import type { HTMLAttributes } from 'react';
import { AlertTriangle, Shield, ChevronRight } from 'lucide-react';
import Card from '../common/Card';
import Badge from '../common/Badge';
import type { Vulnerability } from '../../types';

interface VulnerabilityCardProps extends HTMLAttributes<HTMLDivElement> {
  vulnerability: Vulnerability;
  onClick?: () => void;
}

const getSeverityColor = (severity: Vulnerability['severity']) => {
  const colors = {
    critical: 'text-critical',
    high: 'text-high',
    medium: 'text-medium',
    low: 'text-low',
    info: 'text-info'
  };
  return colors[severity];
};

const getSeverityIcon = (severity: Vulnerability['severity']) => {
  if (severity === 'critical' || severity === 'high') {
    return <AlertTriangle className="w-5 h-5" />;
  }
  return <Shield className="w-5 h-5" />;
};

export function VulnerabilityCard({ vulnerability, onClick, className, ...props }: VulnerabilityCardProps) {
  const severityColor = getSeverityColor(vulnerability.severity);

  return (
    <Card
      className={`hover:shadow-lg transition-shadow cursor-pointer ${className || ''}`}
      onClick={onClick}
      {...props}
    >
      <div className="flex items-start justify-between">
        {/* Icon & Title */}
        <div className="flex items-start space-x-3 flex-1">
          <div className={`p-2 rounded-lg bg-opacity-10 ${severityColor}`}>
            {getSeverityIcon(vulnerability.severity)}
          </div>
          
          <div className="flex-1 min-w-0">
            <div className="flex items-center space-x-2 mb-1">
              <h3 className="font-semibold text-gray-900 dark:text-white truncate">
                {vulnerability.title}
              </h3>
              <Badge variant={vulnerability.severity}>
                {vulnerability.severity.toUpperCase()}
              </Badge>
            </div>
            
            <p className="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">
              {vulnerability.description}
            </p>

            {/* CVSS Score */}
            {vulnerability.cvss_score && (
              <div className="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-500">
                <span className="flex items-center">
                  <span className="font-medium">CVSS:</span>
                  <span className={`ml-1 font-bold ${severityColor}`}>
                    {vulnerability.cvss_score.toFixed(1)}
                  </span>
                </span>
                {vulnerability.cvss_vector && (
                  <span className="font-mono">{vulnerability.cvss_vector}</span>
                )}
              </div>
            )}

            {/* Affected Target */}
            <div className="mt-2 text-xs text-gray-500 dark:text-gray-500">
              Target: <span className="font-mono">{vulnerability.target}</span>
            </div>

            {/* CWE ID */}
            {vulnerability.cwe_id && (
              <div className="mt-1 text-xs text-gray-500 dark:text-gray-500">
                CWE: <span className="font-mono">{vulnerability.cwe_id}</span>
              </div>
            )}
          </div>
        </div>

        {/* Arrow Icon */}
        <ChevronRight className="w-5 h-5 text-gray-400 flex-shrink-0" />
      </div>

      {/* Evidence Preview */}
      {vulnerability.evidence && (
        <div className="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
          <details className="text-xs">
            <summary className="cursor-pointer text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
              View Evidence
            </summary>
            <pre className="mt-2 p-2 bg-gray-100 dark:bg-gray-800 rounded text-xs overflow-x-auto">
              {typeof vulnerability.evidence === 'string' 
                ? vulnerability.evidence 
                : JSON.stringify(vulnerability.evidence, null, 2)}
            </pre>
          </details>
        </div>
      )}
    </Card>
  );
}
