/**
 * SecureRedLab - Vulnerability Heatmap
 * Phase 8.4 - Interactive Components
 * 
 * Vulnerability distribution heatmap by severity and type
 */

import React, { useMemo } from 'react';
import ReactECharts from 'echarts-for-react';
import type { EChartsOption } from 'echarts';
import type { Vulnerability } from '@/types';

interface VulnerabilityHeatmapProps {
  vulnerabilities: Vulnerability[];
  height?: number | string;
  theme?: 'light' | 'dark';
}

const VulnerabilityHeatmap: React.FC<VulnerabilityHeatmapProps> = ({
  vulnerabilities,
  height = 400,
  theme = 'dark'
}) => {
  const option: EChartsOption = useMemo(() => {
    // Define vulnerability categories
    const categories = ['SQL Injection', 'XSS', 'CSRF', 'Authentication', 'Authorization', 'Other'];
    const severities = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'];

    // Create matrix data
    const matrixData: Array<[number, number, number]> = [];
    
    categories.forEach((category, catIndex) => {
      severities.forEach((severity, sevIndex) => {
        const count = vulnerabilities.filter(v => {
          const matchSeverity = v.severity === severity;
          let matchCategory = false;
          
          if (v.name.toLowerCase().includes('sql')) matchCategory = category === 'SQL Injection';
          else if (v.name.toLowerCase().includes('xss')) matchCategory = category === 'XSS';
          else if (v.name.toLowerCase().includes('csrf')) matchCategory = category === 'CSRF';
          else if (v.name.toLowerCase().includes('auth')) matchCategory = category === 'Authentication';
          else if (v.name.toLowerCase().includes('authorization')) matchCategory = category === 'Authorization';
          else matchCategory = category === 'Other';
          
          return matchSeverity && matchCategory;
        }).length;
        
        matrixData.push([catIndex, sevIndex, count]);
      });
    });

    const maxValue = Math.max(...matrixData.map(d => d[2]), 1);

    return {
      backgroundColor: 'transparent',
      tooltip: {
        position: 'top',
        formatter: (params: any) => {
          const [catIndex, sevIndex, count] = params.data;
          return `${categories[catIndex]}<br/>${severities[sevIndex]}: ${count} vulnerabilities`;
        }
      },
      grid: {
        left: '15%',
        right: '10%',
        top: '10%',
        bottom: '15%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: categories,
        axisLabel: {
          color: theme === 'dark' ? '#9ca3af' : '#4b5563',
          interval: 0,
          rotate: 30
        },
        axisLine: {
          lineStyle: {
            color: theme === 'dark' ? '#374151' : '#d1d5db'
          }
        },
        splitArea: {
          show: true
        }
      },
      yAxis: {
        type: 'category',
        data: severities,
        axisLabel: {
          color: theme === 'dark' ? '#9ca3af' : '#4b5563'
        },
        axisLine: {
          lineStyle: {
            color: theme === 'dark' ? '#374151' : '#d1d5db'
          }
        },
        splitArea: {
          show: true
        }
      },
      visualMap: {
        min: 0,
        max: maxValue,
        calculable: true,
        orient: 'horizontal',
        left: 'center',
        bottom: '0%',
        inRange: {
          color: ['#1e3a8a', '#3b82f6', '#f59e0b', '#ef4444', '#7f1d1d']
        },
        textStyle: {
          color: theme === 'dark' ? '#9ca3af' : '#4b5563'
        }
      },
      series: [{
        name: 'Vulnerabilities',
        type: 'heatmap',
        data: matrixData,
        label: {
          show: true,
          color: '#ffffff',
          fontWeight: 'bold'
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }
      }]
    };
  }, [vulnerabilities, theme]);

  return (
    <div className="w-full">
      <ReactECharts
        option={option}
        style={{ height, width: '100%' }}
        theme={theme}
        opts={{ renderer: 'canvas' }}
      />
    </div>
  );
};

export default VulnerabilityHeatmap;
